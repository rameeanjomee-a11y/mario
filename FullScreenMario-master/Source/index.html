<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8" />
    <title>Full Screen Mario</title>
    <meta name="keywords" content="fullscreenmario, full, screen, mario, javascript, html5, gaming, online, online game, fun, distraction" />
    <meta name="description" content="FullScreenMario is a free HTML5 remake of Nintendo's original Super Mario Bros. Play it here!" />

    <!-- build:css index.min.css -->
    <link href="index.css" rel="stylesheet" />
    <!-- /build -->

    <link rel="shortcut icon" href="Theme/Mario.gif">
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>

<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <div class="loading-mario">🍄</div>
            <div class="loading-text">LOADING GAME</div>
            <div class="loading-spinner">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="qr-container">
                <div class="qr-title">SCAN TO PLAY WITH YOUR PHONE</div>
                <div id="qrcode"></div>
                <div class="qr-url" id="controller-url"></div>
            </div>
        </div>
    </div>

    <header>
        <img src="Theme/Header.gif" alt="FullScreenMario.com" />
        <div id="header-right">
            <a class="hoverable" target="_blank" href="https://twitter.com/FullScreenMario">
                <img id="twitter" src="Theme/Twitter.png" alt="Twitter" />
            </a>
            <a class="hoverable" target="_blank" href="https://github.com/FullScreenShenanigans/FullScreenMario">
                <img id="github" src="Theme/Github.png" alt="Github" />
            </a>
            <a class="hoverable" target="_blank" href="https://facebook.com/FullScreenMario">
                <img id="facebook" src="Theme/Facebook.png" alt="Facebook" />
            </a>
        </div>
    </header>

    <section id="game"></section>
    <section id="controls"></section>
    <section id="explanation" class="section-text">
        Play with your phone
        <div id="qrcode-permanent"></div>
    </section>

    <!-- Mario Engine Scripts -->
    <script src="References/AreaSpawnr-0.2.0.js"></script>
    <script src="References/AudioPlayr-0.2.1.js"></script>
    <script src="References/ChangeLinr-0.2.0.js"></script>
    <script src="References/DeviceLayr-0.2.0.js"></script>
    <script src="References/EightBittr-0.2.0.js"></script>
    <script src="References/FPSAnalyzr-0.2.1.js"></script>
    <script src="References/GamesRunnr-0.2.0.js"></script>
    <script src="References/GameStartr-0.2.0.js"></script>
    <script src="References/GroupHoldr-0.2.1.js"></script>
    <script src="References/InputWritr-0.2.0.js"></script>
    <script src="References/ItemsHoldr-0.2.1.js"></script>
    <script src="References/LevelEditr-0.2.0.js"></script>
    <script src="References/MapsCreatr-0.2.1.js"></script>
    <script src="References/MapScreenr-0.2.1.js"></script>
    <script src="References/MathDecidr-0.2.0.js"></script>
    <script src="References/ModAttachr-0.2.2.js"></script>
    <script src="References/NumberMakr-0.2.2.js"></script>
    <script src="References/ObjectMakr-0.2.2.js"></script>
    <script src="References/PixelDrawr-0.2.0.js"></script>
    <script src="References/PixelRendr-0.2.0.js"></script>
    <script src="References/QuadsKeepr-0.2.1.js"></script>
    <script src="References/ScenePlayr-0.2.0.js"></script>
    <script src="References/StringFilr-0.2.1.js"></script>
    <script src="References/ThingHittr-0.2.0.js"></script>
    <script src="References/TimeHandlr-0.2.0.js"></script>
    <script src="References/TouchPassr-0.2.0.js"></script>
    <script src="References/UsageHelpr-0.2.0.js"></script>
    <script src="References/UserWrappr-0.2.0.js"></script>
    <script src="References/WorldSeedr-0.2.0.js"></script>
    <script src="References/js_beautify.js"></script>
    <script src="FullScreenMario.js"></script>
    <script src="settings/audio.js"></script>
    <script src="settings/collisions.js"></script>
    <script src="settings/devices.js"></script>
    <script src="settings/editor.js"></script>
    <script src="settings/generator.js"></script>
    <script src="settings/groups.js"></script>
    <script src="settings/events.js"></script>
    <script src="settings/help.js"></script>
    <script src="settings/input.js"></script>
    <script src="settings/items.js"></script>
    <script src="settings/maps.js"></script>
    <script src="settings/maps/1-1.js"></script>
    <script src="settings/maps/1-2.js"></script>
    <script src="settings/maps/1-3.js"></script>
    <script src="settings/maps/1-4.js"></script>
    <script src="settings/maps/2-1.js"></script>
    <script src="settings/maps/2-2.js"></script>
    <script src="settings/maps/2-3.js"></script>
    <script src="settings/maps/2-4.js"></script>
    <script src="settings/maps/3-1.js"></script>
    <script src="settings/maps/3-2.js"></script>
    <script src="settings/maps/3-3.js"></script>
    <script src="settings/maps/3-4.js"></script>
    <script src="settings/maps/4-1.js"></script>
    <script src="settings/maps/4-2.js"></script>
    <script src="settings/maps/4-3.js"></script>
    <script src="settings/maps/4-4.js"></script>
    <script src="settings/maps/5-1.js"></script>
    <script src="settings/maps/5-2.js"></script>
    <script src="settings/maps/5-3.js"></script>
    <script src="settings/maps/5-4.js"></script>
    <script src="settings/maps/6-1.js"></script>
    <script src="settings/maps/6-2.js"></script>
    <script src="settings/maps/6-3.js"></script>
    <script src="settings/maps/6-4.js"></script>
    <script src="settings/maps/7-1.js"></script>
    <script src="settings/maps/7-2.js"></script>
    <script src="settings/maps/7-3.js"></script>
    <script src="settings/maps/7-4.js"></script>
    <script src="settings/maps/8-1.js"></script>
    <script src="settings/maps/8-2.js"></script>
    <script src="settings/maps/8-3.js"></script>
    <script src="settings/maps/8-4.js"></script>
    <script src="settings/maps/Random.js"></script>
    <script src="settings/math.js"></script>
    <script src="settings/mods.js"></script>
    <script src="settings/objects.js"></script>
    <script src="settings/quadrants.js"></script>
    <script src="settings/renderer.js"></script>
    <script src="settings/runner.js"></script>
    <script src="settings/scenes.js"></script>
    <script src="settings/sprites.js"></script>
    <script src="settings/touch.js"></script>
    <script src="settings/ui.js"></script>
    <script src="index.js"></script>

    <!-- 🚀 Controller Bridge -->
    <script>
      // Dynamic WebSocket URL for both local and production
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const wsUrl = `${protocol}//${window.location.host}`;
      const socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        console.log("Connected to server as mario game client");
        socket.send("register:game:mario");
      };
      
      socket.onerror = (error) => {
        console.error("WebSocket error:", error);
      };
      
      socket.onclose = () => {
        console.log("Disconnected from server");
      };

      socket.onmessage = (event) => {
        const action = event.data;
        triggerInput(action);
      };

      const keyMap = {
        up: 38, down: 40, left: 37, right: 39,   // arrows
        jump: 87,   // W
        shoot: 16,  // Shift
        pause: 80   // P
      };

      function triggerInput(action) {
        const isDown = action.endsWith("_down");
        const isUp = action.endsWith("_up");
        const base = action.replace(/_(down|up)$/, "");
        const code = keyMap[base];
        if (!code && base !== "pause") return;

        if (base === "pause") {
          if (isDown) {
            // P key down
            const keyEvent = new KeyboardEvent("keydown", { keyCode: 80, which: 80, bubbles: true });
            document.body.dispatchEvent(keyEvent);
            // Right-click
            const mouseEvent = new MouseEvent("mousedown", { bubbles: true, which: 3, button: 2 });
            document.body.dispatchEvent(mouseEvent);
          } else if (isUp) {
            const keyUp = new KeyboardEvent("keyup", { keyCode: 80, which: 80, bubbles: true });
            document.body.dispatchEvent(keyUp);
          }
          return;
        }

        if (isDown) {
          const downEvent = new KeyboardEvent("keydown", { keyCode: code, which: code, bubbles: true });
          document.body.dispatchEvent(downEvent);
        } else if (isUp) {
          const upEvent = new KeyboardEvent("keyup", { keyCode: code, which: code, bubbles: true });
          document.body.dispatchEvent(upEvent);
        }
      }
    </script>

    <!-- QR Code Generator -->
    <script>
      // Generate QR code for controller URL
      const controllerUrl = window.location.protocol + '//' + window.location.host + '/';
      
      // Wait for QRCode library to load
      if (typeof QRCode !== 'undefined') {
        // QR code for loading screen
        new QRCode(document.getElementById("qrcode"), {
          text: controllerUrl,
          width: 200,
          height: 200,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
        document.getElementById("controller-url").textContent = controllerUrl;
        
        // QR code for permanent section (create after DOM loads)
        window.addEventListener('DOMContentLoaded', function() {
          new QRCode(document.getElementById("qrcode-permanent"), {
            text: controllerUrl,
            width: 100,
            height: 100,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
        });
      } else {
        console.error('QRCode library not loaded');
      }
    </script>

    <!-- Loading Screen Handler -->
    <script>
      window.addEventListener('load', function() {
        // Wait longer to ensure all game resources and scripts are fully initialized
        // This prevents lag by keeping the loading screen until everything is ready
        setTimeout(function() {
          const loadingScreen = document.getElementById('loading-screen');
          loadingScreen.classList.add('hidden');
          // Remove from DOM after fade out
          setTimeout(function() {
            loadingScreen.style.display = 'none';
          }, 500);
        }, 3000); // Increased to 3 seconds to allow proper initialization
      });
    </script>
</body>
</html>
